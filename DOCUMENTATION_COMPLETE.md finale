# üìö Documentation Compl√®te - LeBoy Platform

**Version:** 1.0  
**Derni√®re mise √† jour:** 15 D√©cembre 2024  
**Framework:** Next.js 16.0.6 (App Router)  
**Langage:** TypeScript 5  
**Base de donn√©es:** PostgreSQL (via Prisma) + JSON (fallback)

---

## üìã Table des mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Pr√©requis techniques](#pr√©requis-techniques)
3. [Installation et configuration](#installation-et-configuration)
4. [Variables d'environnement](#variables-denvironnement)
5. [Base de donn√©es](#base-de-donn√©es)
6. [Structure du projet](#structure-du-projet)
7. [Fonctionnalit√©s principales](#fonctionnalit√©s-principales)
8. [Workflows et processus](#workflows-et-processus)
9. [D√©ploiement](#d√©ploiement)
10. [D√©pannage](#d√©pannage)
11. [Architecture technique](#architecture-technique)
12. [Diagrammes d'architecture](#diagrammes-darchitecture)
13. [S√©curit√© et conformit√©](#s√©curit√©-et-conformit√©)
14. [Scalabilit√© organisationnelle](#scalabilit√©-organisationnelle)

---

## üéØ Vue d'ensemble

**LeBoy** est une plateforme de services con√ßue pour la diaspora, permettant d'ex√©cuter des missions administratives, financi√®res, immobili√®res ou personnelles dans le pays d'origine depuis l'√©tranger.

### Objectifs principaux
- Interface structur√©e pour la diaspora mondiale
- Ex√©cution de missions sur le terrain avec validation finale
- Syst√®me de paiement s√©curis√© (Stripe)
- Gestion compl√®te du workflow : demande ‚Üí mission ‚Üí paiement ‚Üí validation

### Stack technique
- **Frontend/Backend:** Next.js 16.0.6 (App Router)
- **Langage:** TypeScript 5
- **ORM:** Prisma 7.1.0
- **Base de donn√©es:** PostgreSQL (production) + JSON (fallback/d√©veloppement)
- **Paiements:** Stripe
- **Emails:** Resend
- **Styling:** Tailwind CSS 4
- **Authentification:** Sessions (iron-session) + bcryptjs
- **D√©ploiement:** Vercel

---

## üîß Pr√©requis techniques

### Logiciels requis

```bash
# Node.js (version minimale)
node >= 20.9.0

# npm (inclus avec Node.js)
npm >= 10.0.0

# PostgreSQL (pour la base de donn√©es)
postgresql >= 14.0

# Git
git >= 2.30.0
```

### Comptes et services externes

1. **Vercel** - D√©ploiement et hosting
2. **Stripe** - Paiements (compte avec cl√©s TEST et LIVE)
3. **Resend** - Envoi d'emails
4. **PostgreSQL** - Base de donn√©es (Vercel Postgres, Supabase, ou autre)

---

## üöÄ Installation et configuration

### 1. Cloner le projet

```bash
git clone <repository-url>
cd icd-frontend-new
```

### 2. Installer les d√©pendances

```bash
npm install
```

Cette commande installera automatiquement toutes les d√©pendances et g√©n√©rera le client Prisma (`postinstall` hook).

### 3. Configuration de l'environnement

Cr√©er un fichier `.env.local` √† la racine du projet (voir section [Variables d'environnement](#variables-denvironnement)).

### 4. Configuration de la base de donn√©es

#### Option A : Utiliser PostgreSQL (recommand√© pour production)

```bash
# G√©n√©rer le client Prisma
npm run db:generate

# Appliquer les migrations
npm run db:migrate

# (Optionnel) Seeder la base de donn√©es
npm run db:seed
```

#### Option B : Utiliser JSON (d√©veloppement/test)

```bash
# Dans .env.local
USE_DB=false
```

Les donn√©es seront stock√©es dans `data/*.json`.

### 5. Lancer le serveur de d√©veloppement

```bash
npm run dev
```

Le site sera accessible sur `http://localhost:3000`

---

## üîê Variables d'environnement

### Fichier `.env.local` (cr√©er √† la racine)

```bash
# ============================================
# ENVIRONNEMENT
# ============================================
APP_ENV="development"  # development | staging | production
USE_DB="true"           # true pour PostgreSQL, false pour JSON

# ============================================
# BASE DE DONN√âES
# ============================================
# Format PostgreSQL standard
DATABASE_URL="postgresql://user:password@host:port/database?schema=public"

# Exemple Vercel Postgres:
# DATABASE_URL="postgres://default:password@ep-xxx.us-east-1.postgres.vercel-storage.com:5432/verceldb"

# ============================================
# URL DE L'APPLICATION
# ============================================
NEXT_PUBLIC_APP_URL="http://localhost:3000"  # Dev
# NEXT_PUBLIC_APP_URL="https://votre-app.vercel.app"  # Production

# ============================================
# STRIPE (PAIEMENTS)
# ============================================
# IMPORTANT: En staging/dev, utiliser UNIQUEMENT les cl√©s TEST
# Les cl√©s LIVE sont automatiquement bloqu√©es en non-production

# Cl√©s TEST (obligatoires pour staging/dev)
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_SECRET_KEY="sk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."

# Cl√©s LIVE (uniquement pour production)
# NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_live_..."
# STRIPE_SECRET_KEY="sk_live_..."

# Protection Stripe (d√©sactiver les paiements live en staging)
DISABLE_LIVE_STRIPE="true"  # true en staging/dev

# D√©sactiver les paiements aux prestataires (staging uniquement)
DISABLE_PAYOUTS="true"  # true pour forcer MANUAL en staging

# ============================================
# EMAIL (RESEND)
# ============================================
RESEND_API_KEY="re_..."

# Configuration email pour staging
EMAIL_MODE="safe"  # safe | normal
EMAIL_REDIRECT_TO="votre-email@exemple.com"  # Tous les emails redirig√©s ici en mode safe
EMAIL_ALLOWLIST="email1@exemple.com,email2@exemple.com"  # Whitelist d'emails autoris√©s

# Email de l'exp√©diteur
FROM_EMAIL="noreply@leboy.com"
FROM_NAME="LeBoy"

# ============================================
# S√âCURIT√â
# ============================================
SESSION_SECRET="une-longue-chaine-aleatoire-securisee-minimum-32-caracteres"

# ============================================
# STAGING - PROTECTION D'ACC√àS
# ============================================
# Option A: Code d'acc√®s (recommand√©)
STAGING_ACCESS_CODE="code-secret-staging"

# Option B: Whitelist email (alternative)
STAGING_EMAIL_ALLOWLIST="ami1@email.com,ami2@email.com"
```

### Validation des variables

Le syst√®me valide automatiquement les variables critiques au d√©marrage via `lib/env-validation.ts` :
- `APP_ENV` doit √™tre d√©fini
- `DATABASE_URL` requis si `USE_DB=true`
- `NEXT_PUBLIC_APP_URL` requis
- Cl√©s Stripe valid√©es (blocage des cl√©s LIVE en non-production)

---

## üóÑÔ∏è Base de donn√©es

### Architecture

Le syst√®me utilise une **double couche de persistance** :
1. **PostgreSQL** (production) via Prisma
2. **JSON** (fallback/d√©veloppement) via fichiers dans `data/`

Le flag `USE_DB` d√©termine quelle source utiliser. La couche d'abstraction `lib/dataAccess.ts` g√®re automatiquement le basculement.

### Sch√©ma Prisma

Le sch√©ma est d√©fini dans `prisma/schema.prisma`. Principales tables :

- **User** - Utilisateurs (clients, admins, prestataires)
- **Demande** - Demandes initiales des clients
- **Mission** - Missions cr√©√©es √† partir des demandes
- **Prestataire** - Prestataires de services
- **Proposition** - Propositions de prestataires
- **MissionUpdate** - Mises √† jour de missions
- **File** - Fichiers upload√©s
- **Transaction** - Transactions financi√®res

### Commandes Prisma

```bash
# G√©n√©rer le client Prisma
npm run db:generate

# Cr√©er une nouvelle migration
npm run db:migrate

# Appliquer les migrations en production
npm run db:migrate:prod

# Ouvrir Prisma Studio (interface graphique)
npm run db:studio

# R√©initialiser la base (‚ö†Ô∏è supprime toutes les donn√©es)
npm run db:reset

# Seeder la base de donn√©es
npm run db:seed
```

### Migration JSON ‚Üí PostgreSQL

Un script de migration est disponible dans `scripts/migrate-json-to-db.ts` :

```bash
# Migrer toutes les donn√©es JSON vers PostgreSQL
tsx scripts/migrate-json-to-db.ts
```

---

## üìÅ Structure du projet

```
icd-frontend-new/
‚îú‚îÄ‚îÄ app/                          # Next.js App Router
‚îÇ   ‚îú‚îÄ‚îÄ api/                      # Routes API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/                # Routes admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ espace-client/         # Routes espace client
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prestataires/         # Routes prestataires
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ admin/                    # Pages admin
‚îÇ   ‚îú‚îÄ‚îÄ espace-client/            # Pages espace client
‚îÇ   ‚îú‚îÄ‚îÄ prestataires/             # Pages prestataires
‚îÇ   ‚îú‚îÄ‚îÄ components/               # Composants React r√©utilisables
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                # Layout principal
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Page d'accueil
‚îÇ   ‚îî‚îÄ‚îÄ middleware.ts             # Middleware Next.js (auth, staging)
‚îÇ
‚îú‚îÄ‚îÄ lib/                          # Biblioth√®ques et utilitaires
‚îÇ   ‚îú‚îÄ‚îÄ dataAccess.ts             # Couche d'abstraction donn√©es (JSON/DB)
‚îÇ   ‚îú‚îÄ‚îÄ types.ts                  # Types TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                   # Authentification
‚îÇ   ‚îú‚îÄ‚îÄ stripe.ts                 # Configuration Stripe
‚îÇ   ‚îú‚îÄ‚îÄ emailService.ts           # Service d'emails
‚îÇ   ‚îú‚îÄ‚îÄ env-validation.ts         # Validation variables d'environnement
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ repositories/                 # Repositories Prisma (si USE_DB=true)
‚îÇ   ‚îú‚îÄ‚îÄ usersRepo.ts
‚îÇ   ‚îú‚îÄ‚îÄ demandesRepo.ts
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ prisma/                       # Prisma
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma             # Sch√©ma de base de donn√©es
‚îÇ   ‚îî‚îÄ‚îÄ seed.ts                   # Script de seed
‚îÇ
‚îú‚îÄ‚îÄ data/                         # Donn√©es JSON (si USE_DB=false)
‚îÇ   ‚îú‚îÄ‚îÄ users.json
‚îÇ   ‚îú‚îÄ‚îÄ demandes.json
‚îÇ   ‚îú‚îÄ‚îÄ missions.json
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ public/                       # Fichiers statiques
‚îú‚îÄ‚îÄ scripts/                      # Scripts utilitaires
‚îú‚îÄ‚îÄ tests/                        # Tests
‚îÇ
‚îú‚îÄ‚îÄ package.json                  # D√©pendances npm
‚îú‚îÄ‚îÄ tsconfig.json                 # Configuration TypeScript
‚îú‚îÄ‚îÄ next.config.ts                # Configuration Next.js
‚îî‚îÄ‚îÄ .env.local                    # Variables d'environnement (non versionn√©)
```

---

## ‚öôÔ∏è Fonctionnalit√©s principales

### 1. Gestion des demandes

#### Statuts des demandes

- `en_attente` - Demande soumise, en attente de traitement
- `modification_demandee` - Admin a demand√© une modification
  - Champs: `modificationDemandeeAt`, `modificationDemandeeBy`, `messageModification`
  - Client peut modifier et renvoyer via bouton "Renvoie"
- `rejetee` - Demande rejet√©e
  - Champs: `rejeteeAt`, `rejeteeBy`, `raisonRejet`
  - Email automatique au client avec raison
- `acceptee` - Demande accept√©e (mission cr√©√©e)

**Workflow:**
1. Client soumet une demande via `/demandes`
2. Admin analyse et peut :
   - **Assigner un prestataire** ‚Üí Cr√©ation d'une mission
   - **Demander une modification** ‚Üí Statut `modification_demandee`
     - Email envoy√© au client avec message de l'admin
     - Client peut modifier sa demande et renvoyer
     - Bouton "Renvoie" appara√Æt uniquement si modification demand√©e
   - **Rejeter avec explication** ‚Üí Statut `rejetee`
     - Modal admin pour saisir la raison du refus
     - Email automatique au client avec l'explication
3. Si accept√©e ‚Üí cr√©ation d'une mission

**Fichiers cl√©s:**
- `app/demandes/page.tsx` - Formulaire de demande
- `app/admin/demandes/[id]/page.tsx` - D√©tail demande (admin)
  - Modal de refus avec raison d√©taill√©e
  - Modal de demande de modification
- `app/api/admin/demandes/[id]/route.ts` - API gestion demande
  - `PATCH` avec `action: "rejeter"` - Rejet avec raison
  - `PATCH` avec `action: "demander_modification"` - Demande modification
- `app/api/admin/demandes/[id]/resubmit/route.ts` - Renvoi apr√®s modification
- `lib/dataAccess.ts` - Fonctions `requestModificationDemande()`, `resubmitDemande()`

### 2. Gestion des missions

**√âtats internes (MissionInternalState):**
- `CREATED` - Demande cr√©√©e
- `ASSIGNED_TO_PROVIDER` - Assign√©e √† un prestataire
- `PROVIDER_ESTIMATED` - Prestataire a soumis estimation
- `WAITING_CLIENT_PAYMENT` - En attente paiement client
- `PAID_WAITING_TAKEOVER` - Client a pay√©, attente avance prestataire
- `ADVANCE_SENT` - Avance envoy√©e (25%, 50% ou 100%)
- `IN_PROGRESS` - Mission en cours
- `PROVIDER_VALIDATION_SUBMITTED` - Preuves soumises
- `ADMIN_CONFIRMED` - Valid√©e par admin
- `COMPLETED` - Cl√¥tur√©e

**Paiements prestataire:**
- **25%** - Projets √† risque √©lev√©
  - Avance de 25% envoy√©e au d√©marrage
  - Solde de 75% envoy√© apr√®s validation des preuves
- **50%** - Standard
  - Avance de 50% envoy√©e au d√©marrage
  - Solde de 50% envoy√© apr√®s validation des preuves
- **100%** - Risque faible (pharmacies partenaires)
  - Paiement complet envoy√© au d√©marrage
  - **Validation automatique** : Lorsque le prestataire soumet les preuves, elles sont automatiquement valid√©es et envoy√©es au client
  - Pas de solde √† envoyer (d√©j√† pay√© √† 100%)
  - Workflow simplifi√© : Preuves ‚Üí Validation auto ‚Üí Client notifi√©

**Fichiers cl√©s:**
- `app/components/AdminAdvancePaymentSection.tsx` - Interface choix pourcentage (25/50/100%)
- `app/api/admin/missions/[id]/pay-advance/route.ts` - Envoi avance
  - Accepte `avancePercentage: 25 | 50 | 100`
  - Si 100%, marque aussi `soldeVersee = true`
- `app/api/admin/missions/[id]/pay-balance/route.ts` - Envoi solde
  - Ne s'ex√©cute que si avance < 100%
- `app/api/prestataires/espace/missions/[id]/submit-validation/route.ts` - Soumission preuves
  - **Si 100%** : Validation automatique d√©clench√©e imm√©diatement
  - Email client envoy√© automatiquement
  - Statut passe directement √† `ADMIN_CONFIRMED`
- `app/api/admin/missions/[id]/validate-proofs/route.ts` - Validation preuves manuelle
  - Pour 25% et 50% uniquement
  - Si 100%, validation d√©j√† faite automatiquement

### 3. Paiements Stripe

**Configuration:**
- Validation automatique des cl√©s (blocage LIVE en non-production)
- Mode TEST obligatoire en staging/dev
- Webhooks pour les √©v√©nements Stripe

**Fichiers cl√©s:**
- `lib/stripe.ts` - Configuration et validation Stripe
- `app/api/stripe/webhook/route.ts` - Webhook Stripe

### 4. Emails

**Modes:**
- **Normal** - Envoi r√©el
- **Safe** - Redirection ou whitelist (staging)

**Types d'emails:**
- V√©rification email
- Notifications mission
- Confirmations paiement
- Demandes de modification/rejet

**Fichiers cl√©s:**
- `lib/emailService.ts` - Service d'emails

### 5. Authentification

**Syst√®me:**
- Sessions via `iron-session`
- Hashage mots de passe avec `bcryptjs`
- R√¥les: `client`, `prestataire`, `admin`

**Fichiers cl√©s:**
- `lib/auth.ts` - Logique authentification
- `lib/session.ts` - Gestion sessions
- `app/middleware.ts` - Protection routes

### 6. Staging - Protections

**Fonctionnalit√©s:**
- Acc√®s restreint (code ou whitelist)
- `noindex/nofollow` pour SEO
- Banner "STAGING" visible
- Emails en mode safe
- Stripe TEST uniquement
- Paiements prestataire d√©sactiv√©s

**Fichiers cl√©s:**
- `app/middleware.ts` - Contr√¥le d'acc√®s
- `app/staging-access/page.tsx` - Page d'acc√®s
- `app/components/StagingBanner.tsx` - Banner staging
- `app/robots.txt/route.ts` - robots.txt dynamique

---

## üîÑ Workflows et processus

### Workflow complet d'une mission

```
1. CLIENT
   ‚îî‚îÄ> Soumet demande (/demandes)
       ‚îî‚îÄ> Demande cr√©√©e (statut: en_attente)

2. ADMIN
   ‚îî‚îÄ> Analyse demande (/admin/demandes/[id])
       ‚îú‚îÄ> Option A: Demande modification
       ‚îÇ   ‚îî‚îÄ> Email client + statut: modification_demandee
       ‚îÇ       ‚îî‚îÄ> CLIENT modifie et renvoie
       ‚îÇ
       ‚îú‚îÄ> Option B: Rejeter
       ‚îÇ   ‚îî‚îÄ> Email client avec raison + statut: rejetee
       ‚îÇ
       ‚îî‚îÄ> Option C: Assigner prestataire
           ‚îî‚îÄ> Mission cr√©√©e (statut: ASSIGNED_TO_PROVIDER)

3. PRESTATAIRE
   ‚îî‚îÄ> Accepte mission et soumet estimation
       ‚îî‚îÄ> Statut: PROVIDER_ESTIMATED

4. ADMIN
   ‚îî‚îÄ> Valide estimation et g√©n√®re devis
       ‚îî‚îÄ> Statut: WAITING_CLIENT_PAYMENT

5. CLIENT
   ‚îî‚îÄ> Paiement Stripe
       ‚îî‚îÄ> Statut: PAID_WAITING_TAKEOVER

6. ADMIN
   ‚îî‚îÄ> Envoie avance prestataire (25%, 50% ou 100%)
       ‚îî‚îÄ> Statut: ADVANCE_SENT

7. PRESTATAIRE
   ‚îî‚îÄ> Prise en charge + ex√©cution
       ‚îî‚îÄ> Statut: IN_PROGRESS
       ‚îî‚îÄ> Upload preuves + soumission
           ‚îî‚îÄ> Statut: PROVIDER_VALIDATION_SUBMITTED

8. ADMIN (ou automatique si 100%)
   ‚îî‚îÄ> Validation preuves
       ‚îî‚îÄ> Si 100%: Validation automatique
       ‚îî‚îÄ> Si 25%/50%: Envoie solde puis valide
       ‚îî‚îÄ> Statut: ADMIN_CONFIRMED
       ‚îî‚îÄ> Email client avec preuves

9. CLIENT
   ‚îî‚îÄ> Consulte preuves et valide mission
       ‚îî‚îÄ> Statut: COMPLETED
```

### Workflow paiement 100%

**Cas sp√©cial pour achats m√©dicaments (pharmacies partenaires):**

```
1. ADMIN envoie 100% au prestataire
   ‚îî‚îÄ> avancePercentage = 100
   ‚îî‚îÄ> avanceVersee = true
   ‚îî‚îÄ> soldeVersee = true (marqu√© automatiquement, pas de solde restant)
   ‚îî‚îÄ> Statut: ADVANCE_SENT

2. PRESTATAIRE soumet preuves
   ‚îî‚îÄ> Statut: PROVIDER_VALIDATION_SUBMITTED
   ‚îî‚îÄ> D√©tection avancePercentage === 100
   ‚îî‚îÄ> Validation AUTOMATIQUE d√©clench√©e dans submit-validation/route.ts
       ‚îú‚îÄ> Toutes les preuves valid√©es automatiquement
       ‚îú‚îÄ> proofValidatedForClient = true
       ‚îú‚îÄ> Email client envoy√© automatiquement
       ‚îú‚îÄ> Statut: ADMIN_CONFIRMED
       ‚îî‚îÄ> Pas besoin d'intervention admin
       ‚îî‚îÄ> Pas besoin d'envoyer le solde (d√©j√† pay√© √† 100%)

3. CLIENT
   ‚îî‚îÄ> Re√ßoit email avec preuves
   ‚îî‚îÄ> Peut consulter et valider la mission
```

**Avantages:**
- Workflow simplifi√© pour les missions √† faible risque
- Pas d'attente de validation admin
- Traitement automatique d√®s r√©ception des preuves
- Id√©al pour les pharmacies partenaires de confiance

---

## üö¢ D√©ploiement

### D√©ploiement sur Vercel

#### 1. Pr√©paration

```bash
# Build local pour v√©rifier
npm run build

# V√©rifier les erreurs TypeScript
npm run lint
```

#### 2. Configuration Vercel

1. Connecter le repository GitHub √† Vercel
2. Configurer les variables d'environnement (voir section Variables)
3. Configurer la base de donn√©es PostgreSQL (Vercel Postgres recommand√©)

#### 3. Variables d'environnement Vercel

**Production:**
```bash
APP_ENV=production
USE_DB=true
DATABASE_URL=<votre-postgres-url>
NEXT_PUBLIC_APP_URL=https://votre-app.vercel.app
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
RESEND_API_KEY=re_...
SESSION_SECRET=<secret-securise>
```

**Staging:**
```bash
APP_ENV=staging
USE_DB=true
DATABASE_URL=<postgres-staging-url>
NEXT_PUBLIC_APP_URL=https://votre-app-staging.vercel.app
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
RESEND_API_KEY=re_...
SESSION_SECRET=<secret-securise>
STAGING_ACCESS_CODE=<code-secret>
EMAIL_MODE=safe
EMAIL_REDIRECT_TO=votre-email@exemple.com
DISABLE_LIVE_STRIPE=true
DISABLE_PAYOUTS=true
```

#### 4. Build et migrations

Vercel ex√©cutera automatiquement :
- `npm install` (qui inclut `prisma generate` via postinstall)
- `npm run build`

**Important:** Les migrations Prisma doivent √™tre appliqu√©es manuellement :

```bash
# Via Vercel CLI ou interface
vercel env pull .env.local
npm run db:migrate:prod
```

Ou via script de d√©ploiement dans Vercel.

---

## üêõ D√©pannage

### Probl√®mes courants

#### 1. Erreur "Cannot find module '@prisma/client'"

```bash
npm run db:generate
npm install
```

#### 2. Erreur de connexion √† la base de donn√©es

- V√©rifier `DATABASE_URL` dans `.env.local`
- V√©rifier que PostgreSQL est accessible
- V√©rifier les migrations: `npm run db:migrate`

#### 3. Erreur Stripe "Invalid API Key"

- V√©rifier que les cl√©s TEST sont utilis√©es en dev/staging
- V√©rifier `lib/stripe.ts` pour les validations
- Les cl√©s LIVE sont automatiquement bloqu√©es en non-production

#### 4. Erreurs de prerender (useContext, useState)

- Ajouter `export const dynamic = 'force-dynamic';` dans les pages concern√©es
- Utiliser `<Suspense>` pour `useSearchParams()`
- V√©rifier `app/components/LanguageProvider.tsx`

#### 5. Emails non envoy√©s

- V√©rifier `RESEND_API_KEY`
- V√©rifier `EMAIL_MODE` (safe mode peut rediriger/bloquer)
- V√©rifier les logs dans la console

#### 6. Acc√®s staging bloqu√©

- V√©rifier le cookie `staging_ok`
- V√©rifier `STAGING_ACCESS_CODE`
- Acc√©der √† `/staging-access` pour entrer le code

---

## üèóÔ∏è Architecture technique

### Couche de donn√©es

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Application Layer           ‚îÇ
‚îÇ  (app/api/*, app/admin/*, etc.)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      lib/dataAccess.ts              ‚îÇ
‚îÇ   (Couche d'abstraction)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL ‚îÇ ‚îÇ  JSON Files   ‚îÇ
‚îÇ  (Prisma)   ‚îÇ ‚îÇ  (Fallback)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Authentification

```
Request ‚Üí middleware.ts ‚Üí V√©rification session ‚Üí Route prot√©g√©e
                              ‚îÇ
                              ‚îú‚îÄ> Non authentifi√© ‚Üí Redirect /connexion
                              ‚îî‚îÄ> Authentifi√© ‚Üí V√©rification r√¥le ‚Üí Acc√®s
```

### Paiements

```
Client ‚Üí Stripe Checkout ‚Üí Webhook ‚Üí Mise √† jour mission
                              ‚îÇ
                              ‚îî‚îÄ> Validation ‚Üí Paiement confirm√©
```

### Emails

```
Application ‚Üí emailService.ts ‚Üí getSafeRecipient() ‚Üí Resend API
                                      ‚îÇ
                                      ‚îú‚îÄ> Mode safe ‚Üí Redirection/Whitelist
                                      ‚îî‚îÄ> Mode normal ‚Üí Envoi r√©el
```

---

## üìù Commandes utiles

### D√©veloppement

```bash
# Lancer le serveur de d√©veloppement
npm run dev

# Build de production (test local)
npm run build
npm start

# Linter
npm run lint
```

### Base de donn√©es

```bash
# G√©n√©rer le client Prisma
npm run db:generate

# Cr√©er/appliquer migrations
npm run db:migrate

# Ouvrir Prisma Studio
npm run db:studio

# Seeder
npm run db:seed
```

### Tests

```bash
# Tests complets
npm test

# Tests en mode watch
npm run test:watch

# Tests de migration
npm run test:migration
```

---

## üîí S√©curit√©

### Bonnes pratiques impl√©ment√©es

1. **Validation Stripe** - Blocage automatique des cl√©s LIVE en non-production
2. **Validation env** - V√©rification des variables critiques au d√©marrage
3. **Sessions s√©curis√©es** - Hashage des mots de passe, sessions crypt√©es
4. **Protection staging** - Acc√®s restreint, emails safe, noindex
5. **Validation des routes** - Middleware de protection des routes admin/prestataire

### Points d'attention

- Ne jamais commiter `.env.local`
- Utiliser des secrets forts pour `SESSION_SECRET`
- V√©rifier r√©guli√®rement les logs pour d√©tecter les tentatives d'acc√®s
- Mettre √† jour les d√©pendances r√©guli√®rement

---

## üèóÔ∏è Diagrammes d'architecture

### 12.1 Diagramme de contexte (C4 - Niveau 1)

Le diagramme de contexte pr√©sente LeBoy dans son √©cosyst√®me global, montrant les interactions avec les utilisateurs et les syst√®mes externes.

```mermaid
graph TB
    subgraph "Utilisateurs"
        Client[üë§ Client<br/>Diaspora]
        Prestataire[üë§ Prestataire<br/>Local]
        Admin[üë§ Admin<br/>LeBoy]
    end
    
    subgraph "LeBoy Platform"
        App[üåê Application Web<br/>Next.js]
    end
    
    subgraph "Services externes"
        Stripe[üí≥ Stripe<br/>Paiements]
        Resend[üìß Resend<br/>Emails]
        Postgres[(üóÑÔ∏è PostgreSQL<br/>Base de donn√©es)]
    end
    
    Client -->|Soumet demande<br/>Consulte missions| App
    Prestataire -->|Soumet estimation<br/>Upload preuves| App
    Admin -->|G√®re demandes<br/>Valide missions| App
    
    App -->|Paiements| Stripe
    App -->|Notifications| Resend
    App -->|Persistance| Postgres
    
    style App fill:#D4A657,stroke:#0A1B2A,stroke-width:3px
    style Client fill:#E3F2FD,stroke:#1976D2
    style Prestataire fill:#E8F5E9,stroke:#388E3C
    style Admin fill:#FFF3E0,stroke:#F57C00
```

**Acteurs principaux :**
- **Client** : Membre de la diaspora ayant besoin de services dans le pays d'origine
- **Prestataire** : Professionnel local ex√©cutant les missions sur le terrain
- **Admin** : √âquipe LeBoy g√©rant le workflow et la validation

**Syst√®mes externes :**
- **Stripe** : Traitement des paiements clients et versements prestataires
- **Resend** : Envoi d'emails transactionnels et notifications
- **PostgreSQL** : Stockage persistant des donn√©es

---

### 12.2 Diagramme de conteneurs (C4 - Niveau 2)

Le diagramme de conteneurs d√©taille les composants internes de la plateforme et leurs interactions.

```mermaid
graph TB
    subgraph "Frontend"
        Pages[üìÑ Pages Next.js<br/>App Router]
        Components[üß© Composants React<br/>UI/UX]
    end
    
    subgraph "Backend API"
        API_Routes[üõ£Ô∏è Routes API<br/>Next.js API Routes]
        Business_Logic[‚öôÔ∏è Logique m√©tier<br/>lib/*.ts]
    end
    
    subgraph "Couche d'acc√®s donn√©es"
        DataAccess[üîå dataAccess.ts<br/>Abstraction]
        Prisma_Repo[üì¶ Repositories Prisma<br/>PostgreSQL]
        JSON_Store[üìÅ JSON Store<br/>Fallback]
    end
    
    subgraph "Services externes"
        Stripe_API[üí≥ Stripe API]
        Resend_API[üìß Resend API]
    end
    
    subgraph "Base de donn√©es"
        PostgreSQL[(üóÑÔ∏è PostgreSQL)]
        JSON_Files[(üìÅ Fichiers JSON)]
    end
    
    Pages --> Components
    Components --> API_Routes
    API_Routes --> Business_Logic
    Business_Logic --> DataAccess
    DataAccess -->|USE_DB=true| Prisma_Repo
    DataAccess -->|USE_DB=false| JSON_Store
    Prisma_Repo --> PostgreSQL
    JSON_Store --> JSON_Files
    Business_Logic --> Stripe_API
    Business_Logic --> Resend_API
    
    style DataAccess fill:#D4A657,stroke:#0A1B2A,stroke-width:2px
    style API_Routes fill:#E3F2FD,stroke:#1976D2
    style Business_Logic fill:#E8F5E9,stroke:#388E3C
```

**Conteneurs principaux :**

1. **Frontend (Next.js App Router)**
   - Pages serveur et client
   - Composants React r√©utilisables
   - Routing et navigation

2. **Backend API (Next.js API Routes)**
   - Routes RESTful pour toutes les op√©rations
   - Authentification et autorisation
   - Validation des donn√©es

3. **Couche d'acc√®s donn√©es (dataAccess.ts)**
   - Abstraction entre PostgreSQL et JSON
   - Basculement automatique selon `USE_DB`
   - Interface unifi√©e pour toutes les op√©rations

4. **Services externes**
   - Int√©gration Stripe pour paiements
   - Int√©gration Resend pour emails

---

### 12.3 Diagramme d'√©tat des missions (State Machine)

Le diagramme d'√©tat montre le cycle de vie complet d'une mission, avec toutes les transitions possibles.

```mermaid
stateDiagram-v2
    [*] --> CREATED: Client soumet demande
    
    CREATED --> ASSIGNED_TO_PROVIDER: Admin assigne prestataire
    CREATED --> [*]: Admin rejette demande
    
    ASSIGNED_TO_PROVIDER --> PROVIDER_ESTIMATED: Prestataire soumet estimation
    ASSIGNED_TO_PROVIDER --> [*]: Prestataire refuse
    
    PROVIDER_ESTIMATED --> WAITING_CLIENT_PAYMENT: Admin valide estimation
    
    WAITING_CLIENT_PAYMENT --> PAID_WAITING_TAKEOVER: Client paie via Stripe
    
    PAID_WAITING_TAKEOVER --> ADVANCE_SENT: Admin envoie avance (25/50/100%)
    
    ADVANCE_SENT --> IN_PROGRESS: Prestataire prend en charge
    
    IN_PROGRESS --> PROVIDER_VALIDATION_SUBMITTED: Prestataire soumet preuves
    
    PROVIDER_VALIDATION_SUBMITTED --> ADMIN_CONFIRMED: Admin valide preuves
    PROVIDER_VALIDATION_SUBMITTED --> IN_PROGRESS: Admin rejette preuves
    
    note right of ADVANCE_SENT
        Si 100% pay√©:
        soldeVersee = true
        Pas de solde √† envoyer
    end note
    
    note right of PROVIDER_VALIDATION_SUBMITTED
        Si 100% pay√©:
        Validation AUTOMATIQUE
        Email client imm√©diat
    end note
    
    ADMIN_CONFIRMED --> ADMIN_CONFIRMED: Admin envoie solde (si 25% ou 50%)
    ADMIN_CONFIRMED --> COMPLETED: Client valide mission
    
    COMPLETED --> [*]: Mission cl√¥tur√©e
    
    state ADVANCE_SENT {
        [*] --> 25_PERCENT: 25% vers√©
        [*] --> 50_PERCENT: 50% vers√©
        [*] --> 100_PERCENT: 100% vers√©
    }
```

**√âtats principaux :**

| √âtat | Description | Acteur responsable |
|------|-------------|-------------------|
| `CREATED` | Demande cr√©√©e, en attente traitement | Client |
| `ASSIGNED_TO_PROVIDER` | Assign√©e √† un prestataire | Admin |
| `PROVIDER_ESTIMATED` | Estimation soumise | Prestataire |
| `WAITING_CLIENT_PAYMENT` | En attente paiement client | Client |
| `PAID_WAITING_TAKEOVER` | Client a pay√©, attente avance | Admin |
| `ADVANCE_SENT` | Avance envoy√©e (25/50/100%) | Admin |
| `IN_PROGRESS` | Mission en cours | Prestataire |
| `PROVIDER_VALIDATION_SUBMITTED` | Preuves soumises | Prestataire |
| `ADMIN_CONFIRMED` | Valid√©e par admin | Admin |
| `COMPLETED` | Cl√¥tur√©e | Client |

**Transitions sp√©ciales (100%) :**

- Si `avancePercentage === 100` :
  - `soldeVersee` est automatiquement `true`
  - Lors de la soumission des preuves ‚Üí validation automatique
  - Email client envoy√© imm√©diatement
  - Pas de solde √† envoyer

---

### 12.4 Sch√©ma simplifi√© du type Mission

Structure simplifi√©e du type `Mission` pour une lecture rapide.

```mermaid
classDiagram
    class Mission {
        +number id
        +string ref
        +number demandeId
        +number prestataireId
        +MissionInternalState internalState
        +MissionStatus status
        
        +string titre
        +string serviceType
        +string description
        
        +number tarifPrestataire
        +number tarifTotal
        +number commissionTotale
        
        +boolean avanceVersee
        +number avancePercentage (25|50|100)
        +boolean soldeVersee
        
        +MissionProof[] proofs
        +MissionUpdate[] updates
        +ExecutionPhase[] phases
        
        +Date createdAt
        +Date dateDebut
        +Date dateFin
    }
    
    class MissionProof {
        +string id
        +string type
        +string fileUrl
        +boolean validatedByAdmin
        +Date validatedAt
    }
    
    class MissionUpdate {
        +number id
        +MissionUpdateType type
        +string author
        +string content
        +Date createdAt
    }
    
    class ExecutionPhase {
        +string id
        +string nom
        +boolean completed
        +Date completedAt
        +number ordre
    }
    
    Mission "1" *-- "many" MissionProof
    Mission "1" *-- "many" MissionUpdate
    Mission "1" *-- "many" ExecutionPhase
```

**Champs critiques :**

- **√âtat** : `internalState` (source de v√©rit√©) et `status` (d√©riv√© pour affichage)
- **Paiement** : `avancePercentage` (25/50/100), `avanceVersee`, `soldeVersee`
- **Preuves** : `proofs[]` avec validation admin
- **Progression** : `phases[]` pour suivi d√©taill√©
- **Historique** : `updates[]` pour tra√ßabilit√©

---

## üîí S√©curit√© et conformit√©

### 13.1 Gestion RGPD

#### Droit √† l'oubli

**Impl√©mentation actuelle :**

Le syst√®me utilise un **soft delete** pour toutes les entit√©s sensibles :

```typescript
// Exemple dans Mission
deleted?: boolean;
deletedAt?: string;
deletedBy?: "client" | "prestataire" | "admin";
```

**Actions requises pour conformit√© RGPD :**

1. **Anonymisation des donn√©es personnelles**
   - Email ‚Üí hash anonyme
   - Nom complet ‚Üí "Utilisateur supprim√©"
   - T√©l√©phone ‚Üí supprim√©
   - Adresse ‚Üí supprim√©e

2. **Suppression d√©finitive apr√®s d√©lai**
   - D√©lai de r√©tention : 3 ans apr√®s cl√¥ture
   - Archivage automatique apr√®s 1 an
   - Suppression d√©finitive apr√®s 3 ans

3. **Export des donn√©es utilisateur**
   - Endpoint `/api/user/data-export` √† impl√©menter
   - Format JSON/PDF pour portabilit√©

**Recommandation : Cr√©er un service d'anonymisation**

```typescript
// lib/gdpr/anonymization.ts (√† cr√©er)
export async function anonymizeUserData(userId: string): Promise<void> {
  // Anonymiser toutes les r√©f√©rences
  // - Missions
  // - Demandes
  // - Messages
  // - Fichiers
}
```

#### Consentement et traitement des donn√©es

**Donn√©es collect√©es :**
- Email, nom, t√©l√©phone (n√©cessaires pour le service)
- Documents upload√©s (preuves, justificatifs)
- Historique des transactions
- Logs d'activit√©

**Base l√©gale :**
- Ex√©cution d'un contrat (service demand√©)
- Consentement explicite (checkbox lors de l'inscription)

**Dur√©e de conservation :**
- Donn√©es actives : dur√©e de vie du compte
- Donn√©es archiv√©es : 3 ans apr√®s cl√¥ture
- Logs : 1 an

---

### 13.2 Journalisation et audit (Audit Log)

#### √âtat actuel

Le syst√®me enregistre certaines actions dans `MissionUpdate` :

```typescript
{
  type: "status_change",
  author: "admin",
  authorEmail: "admin@leboy.com",
  content: "√âtat chang√© de X √† Y",
  createdAt: "2025-01-15T10:30:00Z"
}
```

#### Recommandation : Mod√®le AuditLog d√©di√©

**Sch√©ma Prisma propos√© :**

```prisma
model AuditLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  
  // Qui
  userId    String?
  userEmail String?
  userRole  String?  // "admin" | "prestataire" | "client"
  
  // Quoi
  action    String   // "mission.created", "payment.sent", "proof.validated"
  entityType String  // "Mission", "Demande", "User"
  entityId   String
  
  // D√©tails
  metadata  Json?    // Donn√©es contextuelles
  ipAddress String?
  userAgent String?
  
  // Pourquoi (optionnel)
  reason    String?
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
```

**Actions critiques √† auditer :**

1. **Authentification**
   - Connexion / D√©connexion
   - Tentatives d'acc√®s √©chou√©es
   - Changement de mot de passe

2. **Gestion des missions**
   - Cr√©ation / Modification / Suppression
   - Changements d'√©tat
   - Assignation prestataire

3. **Paiements**
   - Envoi avance / solde
   - Validation paiement client
   - Modifications tarifs

4. **Donn√©es sensibles**
   - Acc√®s aux preuves
   - T√©l√©chargement de documents
   - Export de donn√©es

**Impl√©mentation recommand√©e :**

```typescript
// lib/audit/auditLogger.ts (√† cr√©er)
export async function logAction(params: {
  userId?: string;
  userEmail?: string;
  userRole?: UserRole;
  action: string;
  entityType: string;
  entityId: string;
  metadata?: Record<string, any>;
  reason?: string;
}): Promise<void> {
  // Enregistrer dans AuditLog
  // Optionnel: envoyer √† service externe (Sentry, LogRocket)
}
```

---

### 13.3 S√©curit√© des donn√©es

#### Chiffrement

- **Mots de passe** : bcryptjs (hash, pas de chiffrement r√©versible)
- **Sessions** : iron-session avec secret crypt√©
- **Donn√©es sensibles** : √Ä consid√©rer pour donn√©es tr√®s sensibles (ex: num√©ros de compte)

#### Protection des routes

- **Middleware Next.js** : V√©rification des r√¥les
- **API Routes** : Validation `getUserRoleAsync()` avant chaque action
- **Staging** : Acc√®s restreint via code/whitelist

#### Validation des entr√©es

- **TypeScript** : Typage strict
- **Validation runtime** : Validation des donn√©es API
- **Sanitization** : Protection XSS dans les champs texte

---

## üåç Scalabilit√© organisationnelle

### 14.1 Architecture multi-pays / multi-r√©glementation

#### √âtat actuel

Le syst√®me g√®re d√©j√† un champ `country` dans les demandes et prestataires :

```typescript
// Demande
country?: string; // Code pays (ex: "CM", "SN")

// Prestataire
pays: string[]; // Liste des pays couverts
```

#### Recommandation : Mod√®le Pays/R√©gion formalis√©

**Sch√©ma Prisma propos√© :**

```prisma
model Country {
  id          String   @id @default(uuid())
  code        String   @unique // ISO 3166-1 alpha-2 (ex: "CM")
  name        String
  nameFr      String
  nameEn      String
  
  // R√©glementation
  currency    String   // "XAF", "XOF", etc.
  timezone    String   // "Africa/Douala"
  
  // Configuration
  isActive    Boolean  @default(true)
  requiresVAT Boolean @default(false)
  vatRate     Float?   // Taux TVA si applicable
  
  // Relations
  regions     Region[]
  prestataires Prestataire[]
  demandes    Demande[]
  
  @@map("countries")
}

model Region {
  id        String   @id @default(uuid())
  countryId String
  code      String   // Code r√©gion (ex: "CM-CE" pour Centre)
  name      String
  nameFr    String
  nameEn    String
  
  country   Country  @relation(fields: [countryId], references: [id])
  
  @@unique([countryId, code])
  @@map("regions")
}
```

**Avantages :**
- Centralisation des configurations pays
- Gestion des r√©glementations sp√©cifiques
- Facilite l'extension multi-diaspora
- Support des devises multiples

---

### 14.2 Strat√©gie multi-tenant

#### Option A : Soft Tenant (recommand√© pour MVP)

**Principe :** S√©paration logique via `countryCode` sans isolation physique.

```typescript
// Toutes les requ√™tes filtrent par countryCode
const missions = await prisma.mission.findMany({
  where: {
    demande: {
      country: countryCode // Filtre automatique
    }
  }
});
```

**Avantages :**
- Simple √† impl√©menter
- Pas de duplication de code
- Partage des ressources

**Inconv√©nients :**
- Isolation limit√©e
- Performance si tr√®s grande √©chelle

**Impl√©mentation :**

```typescript
// lib/tenant/tenantContext.ts (√† cr√©er)
export function getTenantContext(): { countryCode: string } {
  // R√©cup√©rer depuis session/utilisateur
  return { countryCode: user.country || "CM" };
}

// Middleware automatique
export function withTenantFilter<T>(
  query: (tenant: { countryCode: string }) => Promise<T>
): Promise<T> {
  const tenant = getTenantContext();
  return query(tenant);
}
```

#### Option B : Hard Tenant (pour tr√®s grande √©chelle)

**Principe :** Isolation physique via base de donn√©es s√©par√©e ou sch√©ma PostgreSQL.

**Architecture propos√©e :**

```
PostgreSQL
‚îú‚îÄ‚îÄ Schema: leboy_cm (Cameroun)
‚îú‚îÄ‚îÄ Schema: leboy_sn (S√©n√©gal)
‚îî‚îÄ‚îÄ Schema: leboy_shared (Donn√©es partag√©es)
```

**Avantages :**
- Isolation compl√®te
- Performance optimale
- S√©curit√© renforc√©e

**Inconv√©nients :**
- Complexit√© accrue
- Migration plus difficile
- Co√ªt infrastructure

**Quand utiliser Hard Tenant :**
- Plus de 100K utilisateurs par pays
- R√©glementations tr√®s diff√©rentes
- Besoin d'isolation l√©gale stricte

---

### 14.3 Extension multi-diaspora

#### Pr√©paration actuelle

Le syst√®me est d√©j√† con√ßu pour √™tre inclusif :
- Pas de r√©f√©rence explicite √† un pays sp√©cifique dans le code
- Champs `country` disponibles partout
- Copy adapt√©e pour diaspora globale

#### Roadmap d'extension

**Phase 1 : Multi-pays (actuel)**
- ‚úÖ Support de plusieurs pays dans les demandes
- ‚úÖ Prestataires multi-pays
- ‚è≥ Configuration pays centralis√©e (√† impl√©menter)

**Phase 2 : Multi-r√©glementation**
- Configuration TVA par pays
- Devises multiples
- R√®gles sp√©cifiques par pays

**Phase 3 : Multi-tenant complet**
- Isolation par pays si n√©cessaire
- Tableaux de bord par pays
- Rapports s√©par√©s

**Phase 4 : Internationalisation compl√®te**
- Langues multiples (FR, EN, AR, etc.)
- Formats de date/heure localis√©s
- Devises et formats num√©riques

---

### 14.4 Recommandations d'impl√©mentation

#### Priorit√© 1 (Court terme)

1. **Mod√®le Country/Region**
   - Cr√©er les tables Prisma
   - Migrer les donn√©es existantes
   - API de gestion des pays

2. **Audit Log**
   - Cr√©er le mod√®le AuditLog
   - Logger les actions critiques
   - Dashboard d'audit pour admin

#### Priorit√© 2 (Moyen terme)

3. **Anonymisation RGPD**
   - Service d'anonymisation
   - Suppression automatique apr√®s d√©lai
   - Export des donn√©es utilisateur

4. **Soft Tenant**
   - Middleware de filtrage automatique
   - Context tenant dans toutes les requ√™tes
   - Tests d'isolation

#### Priorit√© 3 (Long terme)

5. **Hard Tenant** (si n√©cessaire)
   - Architecture multi-sch√©ma
   - Migration des donn√©es
   - Monitoring par tenant

6. **Internationalisation**
   - Syst√®me de traduction
   - Formats localis√©s
   - Support multi-langue

---

## üìû Support et ressources

### Documentation suppl√©mentaire

- `STAGING_SETUP.md` - Configuration d√©taill√©e staging
- `STAGING_IMPLEMENTATION_SUMMARY.md` - R√©sum√© technique staging
- `REJECT_FEATURE_SUMMARY.md` - Fonctionnalit√© de refus avec modal
- `COPY_UPDATE_SUMMARY.md` - Mises √† jour de contenu
- `TEST_STAGING_LOCAL.md` - Guide de test staging local

### Structure des donn√©es

Les types TypeScript sont d√©finis dans :
- `lib/types.ts` - Types principaux (Mission, MissionUpdate, MissionInternalState, etc.)
- `lib/demandesStore.ts` - Type DemandeICD (avec statuts modification_demandee, rejetee)
- `lib/prestatairesStore.ts` - Type Prestataire
- `lib/usersStore.ts` - Type User

### Composants React cl√©s

- `app/components/LanguageProvider.tsx` - Gestion i18n (FR/EN)
- `app/components/StagingBanner.tsx` - Banner staging
- `app/components/AdminAdvancePaymentSection.tsx` - Interface paiement prestataire (25/50/100%)
- `app/components/MissionProgressBar.tsx` - Barre de progression mission
- `app/components/MissionChat.tsx` - Chat mission
- `app/components/MissionProofView.tsx` - Visualisation preuves

### Routes API principales

**Admin:**
- `/api/admin/demandes/[id]` - Gestion demandes (GET, PATCH, DELETE)
- `/api/admin/missions/[id]/pay-advance` - Envoi avance prestataire
- `/api/admin/missions/[id]/pay-balance` - Envoi solde prestataire
- `/api/admin/missions/[id]/validate-proofs` - Validation preuves
- `/api/admin/missions/[id]/generate-devis` - G√©n√©ration devis PDF

**Prestataire:**
- `/api/prestataires/espace/missions/[id]/submit-validation` - Soumission preuves
- `/api/prestataires/espace/missions/[id]/estimation` - Soumission estimation

**Client:**
- `/api/espace-client/missions/[id]/validate` - Validation mission par client

**Staging:**
- `/api/staging-access` - Validation code d'acc√®s staging

---

## ‚úÖ Checklist de d√©marrage

### Installation initiale

- [ ] Node.js >= 20.9.0 install√© (`node --version`)
- [ ] PostgreSQL configur√© et accessible (ou utiliser JSON avec `USE_DB=false`)
- [ ] Fichier `.env.local` cr√©√© avec toutes les variables requises
- [ ] `npm install` ex√©cut√© avec succ√®s
- [ ] `npm run db:generate` ex√©cut√© (si `USE_DB=true`)
- [ ] `npm run db:migrate` ex√©cut√© (si `USE_DB=true`)
- [ ] `npm run dev` fonctionne sans erreurs
- [ ] Acc√®s √† `http://localhost:3000` OK
- [ ] Build de production test√© : `npm run build`

### Configuration services

- [ ] Compte Stripe cr√©√© (cl√©s TEST obtenues)
- [ ] Compte Resend cr√©√© (API key obtenue)
- [ ] Base de donn√©es PostgreSQL configur√©e (si production)
- [ ] Variables d'environnement valid√©es (pas d'erreurs au d√©marrage)

### Comptes utilisateurs

- [ ] Compte admin cr√©√© (via `/inscription` ou seed)
- [ ] Compte prestataire test cr√©√©
- [ ] Compte client test cr√©√©
- [ ] Connexion fonctionne pour chaque type de compte

### Tests fonctionnels

- [ ] Cr√©ation d'une demande fonctionne (`/demandes`)
- [ ] Connexion admin fonctionne (`/admin`)
- [ ] Assignation prestataire fonctionne
- [ ] Paiement Stripe (mode test) fonctionne
- [ ] Envoi avance prestataire fonctionne (25%, 50%, 100%)
- [ ] Soumission preuves fonctionne
- [ ] Validation automatique 100% fonctionne
- [ ] Validation preuves manuelle fonctionne (25%, 50%)
- [ ] Emails re√ßus (v√©rifier Resend dashboard)
- [ ] Demande de modification fonctionne
- [ ] Refus avec raison fonctionne

### Staging (si applicable)

- [ ] Variables staging configur√©es (`APP_ENV=staging`)
- [ ] Code d'acc√®s staging d√©fini (`STAGING_ACCESS_CODE`)
- [ ] Mode email "safe" activ√© (`EMAIL_MODE=safe`)
- [ ] Banner staging visible sur toutes les pages
- [ ] Acc√®s restreint fonctionne (`/staging-access`)
- [ ] `robots.txt` bloque les crawlers
- [ ] Meta tags `noindex` pr√©sents

### Production (si d√©ploiement)

- [ ] Variables production configur√©es sur Vercel
- [ ] Base de donn√©es production migr√©e
- [ ] Cl√©s Stripe LIVE configur√©es (production uniquement)
- [ ] Domain personnalis√© configur√© (si applicable)
- [ ] Webhooks Stripe configur√©s
- [ ] Monitoring et logs configur√©s

---

## üîÑ Mises √† jour r√©centes

### D√©cembre 2024

- ‚úÖ **Paiement 100%** - Ajout option paiement complet avec validation automatique des preuves
- ‚úÖ **Demande de modification** - Admin peut demander modification avec message, client peut renvoyer
- ‚úÖ **Refus avec raison** - Modal professionnel pour refus avec explication d√©taill√©e au client
- ‚úÖ **Design institutionnel** - Refonte page d'accueil style sobre et professionnel
- ‚úÖ **Diaspora globale** - Suppression r√©f√©rences pays sp√©cifiques, inclusivit√© totale
- ‚úÖ **Domaines cliquables** - Effet hover am√©lior√© sur les domaines d'intervention
- ‚úÖ **Villes mises √† jour** - Liste des grandes villes uniquement (suppression villages)

---

**Document cr√©√© le:** 15 D√©cembre 2024  
**Derni√®re mise √† jour:** 15 D√©cembre 2024  
**Version:** 1.0  
**Maintenu par:** √âquipe LeBoy

